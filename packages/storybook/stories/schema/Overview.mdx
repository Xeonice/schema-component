import { Meta } from '@storybook/blocks'

<Meta title="Schema/Overview" />

# Schema åŒ…æ¦‚è¿°

`@schema-component/schema` æ˜¯ Schema Component çš„æ ¸å¿ƒåŒ…ï¼Œæä¾›ç±»å‹å®‰å…¨ã€é«˜æ€§èƒ½ã€æ˜“äºä½¿ç”¨çš„æ•°æ®æ¨¡å¼å®šä¹‰ä¸éªŒè¯æ¡†æ¶ã€‚

## è®¾è®¡ç†å¿µ

### æ ¸å¿ƒç›®æ ‡

- **å®Œæ•´çš„ç±»å‹ç³»ç»Ÿ**: æ”¯æŒæ‰€æœ‰åŸºç¡€æ•°æ®ç±»å‹å’Œå…³è”å…³ç³»
- **å¼ºå¤§çš„å…³è”å­—æ®µ**: å®Œæ•´æ”¯æŒ o2o, o2m, m2o, m2m å››ç§å…³è”ç±»å‹
- **çµæ´»çš„é…ç½®é€‰é¡¹**: é€šè¿‡ withOption æä¾›é“¾å¼é…ç½®èƒ½åŠ›
- **TypeScript åŸç”Ÿ**: æ·±åº¦é›†æˆ TypeScript ç±»å‹æ¨å¯¼
- **è¿è¡Œæ—¶éªŒè¯**: åŸºäº Zod çš„å¼ºå¤§éªŒè¯å¼•æ“
- **å¯æ‰©å±•æ¶æ„**: æ”¯æŒ Schema ç»„åˆã€ç»§æ‰¿å’Œè‡ªå®šä¹‰è§„åˆ™

### æŠ€æœ¯æ¶æ„

#### æ··åˆæ¶æ„ï¼šZod + TypeBox

ç»è¿‡å¯¹ä¸»æµ TypeScript Schema éªŒè¯åº“çš„æ·±å…¥è°ƒç ”ï¼Œæœ¬ç³»ç»Ÿé‡‡ç”¨æ··åˆæ¶æ„ï¼š

**âš¡ Zod ä½œä¸ºæ ¸å¿ƒéªŒè¯å¼•æ“**
- âœ… æˆç†Ÿç¨³å®šï¼Œç¤¾åŒºç”Ÿæ€å®Œå–„
- âœ… ä¼˜ç§€çš„ TypeScript ç±»å‹æ¨å¯¼
- âœ… å®Œæ•´çš„ API è®¾è®¡å’Œæ–‡æ¡£
- âœ… å¹¿æ³›çš„ç¬¬ä¸‰æ–¹é›†æˆï¼ˆtRPCã€React Hook Form ç­‰ï¼‰
- âœ… ä¸°å¯Œçš„éªŒè¯åŠŸèƒ½å’Œé”™è¯¯å¤„ç†

**ğŸ“¦ TypeBox ä½œä¸º JSON Schema æ¡¥æ¥**
- âš¡ æè‡´æ€§èƒ½ï¼ˆæœ€å¿«çš„éªŒè¯åº“ï¼‰
- ğŸ“‹ å®Œå…¨ç¬¦åˆ JSON Schema æ ‡å‡†
- ğŸ”— æ”¯æŒ OpenAPI æ–‡æ¡£ç”Ÿæˆ
- ğŸŒ é€‚åˆ API å’Œè·¨å¹³å°åœºæ™¯

**ğŸ’¡ æ¶æ„ä¼˜åŠ¿**
- å†…éƒ¨ä½¿ç”¨ Zodï¼šåˆ©ç”¨å…¶å¼ºå¤§çš„éªŒè¯å’Œç±»å‹æ¨å¯¼èƒ½åŠ›
- å¯¹å¤–æš´éœ²æ ‡å‡†ï¼šé€šè¿‡ TypeBox è¾“å‡ºæ ‡å‡† JSON Schema
- ç±»å‹å®‰å…¨ä¸æ ‡å‡†å…¼å¾—ï¼šä¸¤å…¨å…¶ç¾çš„è§£å†³æ–¹æ¡ˆ
- æˆç†Ÿç”Ÿæ€æ”¯æŒï¼šæ— ç¼é›†æˆä¸»æµå·¥å…·é“¾

---

## æ ¸å¿ƒæ¦‚å¿µ

### Schema å®šä¹‰

Schema æ˜¯æ•°æ®æ¨¡å‹çš„è“å›¾ï¼Œå®šä¹‰äº†ï¼š

- **å­—æ®µç±»å‹**: åŸºç¡€å­—æ®µå’Œå…³è”å­—æ®µ
- **éªŒè¯è§„åˆ™**: æ•°æ®éªŒè¯é€»è¾‘
- **å…³ç³»å®šä¹‰**: æ¨¡å‹é—´çš„å…³è”å…³ç³»
- **ç±»å‹æ¨å¯¼**: è‡ªåŠ¨çš„ TypeScript ç±»å‹

### å­—æ®µç±»å‹

#### åŸºç¡€å­—æ®µ (8 ç§)

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **String** | å­—ç¬¦ä¸² | `field.string()` |
| **Number** | æ•°å€¼ | `field.integer()`, `field.float()` |
| **Boolean** | å¸ƒå°”å€¼ | `field.boolean()` |
| **Date** | æ—¥æœŸæ—¶é—´ | `field.date()`, `field.timestamp()` |
| **Enum** | æšä¸¾ | `field.enum({ values: [...] })` |
| **JSON** | JSON å¯¹è±¡ | `field.json()` |
| **Array** | æ•°ç»„ | `field.array({ items: ... })` |
| **Binary** | äºŒè¿›åˆ¶ | `field.binary()` |

#### å…³è”å­—æ®µ (4 ç§)

| å…³ç³» | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **One-to-One** | ä¸€å¯¹ä¸€ | `relation.one('Profile')` |
| **One-to-Many** | ä¸€å¯¹å¤š | `relation.many('Post')` |
| **Many-to-One** | å¤šå¯¹ä¸€ | `relation.belongsTo('User')` |
| **Many-to-Many** | å¤šå¯¹å¤š | `relation.manyToMany('Tag')` |

## å¿«é€Ÿç¤ºä¾‹

### å®šä¹‰ User Schema

```typescript
import { defineSchema, field, relation } from '@schema-component/schema'

const UserSchema = defineSchema('User', {
  id: field.uuid({ primary: true }),
  username: field.string({ required: true, unique: true }),
  email: field.email({ required: true, unique: true }),
  age: field.integer({ min: 0, max: 150 }),
  status: field.enum({
    values: ['active', 'inactive', 'banned'] as const,
    default: 'active'
  }),

  // æ—¶é—´æˆ³
  createdAt: field.timestamp({ autoCreate: true }),
  updatedAt: field.timestamp({ autoUpdate: true }),

  // å…³è”
  profile: relation.one('Profile'),
  posts: relation.many('Post', { foreignKey: 'authorId' })
})
```

### éªŒè¯æ•°æ®

```typescript
const result = UserSchema.safeParse({
  username: 'john_doe',
  email: 'john@example.com',
  age: 25
})

if (result.success) {
  console.log(result.data) // ç±»å‹å®‰å…¨çš„æ•°æ®
} else {
  console.error(result.errors) // éªŒè¯é”™è¯¯
}
```

### ç±»å‹æ¨å¯¼

```typescript
import { Infer } from '@schema-component/schema'

type User = Infer<typeof UserSchema>
// è‡ªåŠ¨æ¨å¯¼ä¸º:
// {
//   id: string
//   username: string
//   email: string
//   age?: number
//   status?: 'active' | 'inactive' | 'banned'
//   createdAt: Date
//   updatedAt: Date
//   profile?: Profile
//   posts?: Post[]
// }
```

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”’ ç±»å‹å®‰å…¨

å®Œæ•´çš„ TypeScript ç±»å‹æ¨å¯¼ï¼Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ã€‚

### âœ… å¼ºå¤§éªŒè¯

åŸºäº Zod çš„éªŒè¯ç³»ç»Ÿï¼Œæ”¯æŒåŒæ­¥/å¼‚æ­¥éªŒè¯ã€‚

### ğŸ”— å…³è”å…³ç³»

æ”¯æŒæ‰€æœ‰å¸¸è§çš„æ•°æ®åº“å…³ç³»ç±»å‹ã€‚

### ğŸ¯ çµæ´»é…ç½®

é€šè¿‡ `withOption` å‡½æ•°çµæ´»é…ç½®å­—æ®µé€‰é¡¹ã€‚

### ğŸ“¦ æ ‡å‡†å…¼å®¹

æ”¯æŒå¯¼å‡ºä¸º JSON Schemaã€OpenAPIã€Prisma ç­‰æ ‡å‡†æ ¼å¼ã€‚

## é«˜çº§ç‰¹æ€§

### Schema ç»„åˆä¸ç»§æ‰¿

é€šè¿‡ç»„åˆå¯å¤ç”¨å­—æ®µç»„ï¼Œé¿å…é‡å¤å®šä¹‰ï¼š

```typescript
// å¯å¤ç”¨å­—æ®µç»„
const TimestampFields = {
  createdAt: field.timestamp({ autoCreate: true }),
  updatedAt: field.timestamp({ autoUpdate: true })
}

// ç»„åˆä½¿ç”¨
const PostSchema = defineSchema('Post', {
  id: field.uuid({ primary: true }),
  title: field.string({ required: true }),
  ...TimestampFields
})

// æ‰©å±• Schema
const FeaturedPostSchema = PostSchema.extend({
  featured: field.boolean({ default: false })
})
```

### è™šæ‹Ÿå­—æ®µ

å®šä¹‰ä¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„è®¡ç®—å­—æ®µï¼š

```typescript
const PersonSchema = defineSchema('Person', {
  firstName: field.string(),
  lastName: field.string(),

  // è™šæ‹Ÿå­—æ®µ - è‡ªåŠ¨è®¡ç®—
  fullName: field.virtual({
    get: (person) => `${person.firstName} ${person.lastName}`
  })
})
```

### æ¡ä»¶éªŒè¯

æ ¹æ®å…¶ä»–å­—æ®µçš„å€¼åŠ¨æ€è°ƒæ•´éªŒè¯è§„åˆ™ï¼š

```typescript
const OrderSchema = defineSchema('Order', {
  type: field.enum({ values: ['pickup', 'delivery'] as const }),

  // å½“ type ä¸º delivery æ—¶ï¼Œaddress å¿…å¡«
  address: withOption(field.string(), {
    required: (data) => data.type === 'delivery'
  })
})
```

---

## å­¦ä¹ è·¯å¾„

æ¨èæŒ‰ä»¥ä¸‹é¡ºåºå­¦ä¹ ï¼š

1. **åŸºç¡€ä½¿ç”¨** â†’ äº†è§£åŸºç¡€å­—æ®µç±»å‹å’Œ Schema å®šä¹‰
2. **å…³è”å…³ç³»** â†’ å­¦ä¹ å››ç§å…³è”ç±»å‹çš„ä½¿ç”¨
3. **é«˜çº§ç‰¹æ€§** â†’ æŒæ¡ withOptionã€Schema ç»„åˆã€è™šæ‹Ÿå­—æ®µ
4. **å®Œæ•´ç¤ºä¾‹** â†’ é€šè¿‡å®é™…é¡¹ç›®æ¡ˆä¾‹ï¼ˆåšå®¢ã€ç”µå•†ï¼‰æ·±å…¥ç†è§£
5. **API å‚è€ƒ** â†’ æŸ¥é˜…å®Œæ•´çš„ API æ–‡æ¡£
6. **æœ€ä½³å®è·µ** â†’ å­¦ä¹ æ¨èçš„è®¾è®¡æ¨¡å¼å’Œä¼˜åŒ–æŠ€å·§

---

## æ·±å…¥å­¦ä¹ 

æ¢ç´¢æ›´å¤šå†…å®¹ï¼š

- ğŸ“– **[Complete Examples](/story/schema-complete-examples--basic-user)** - å®Œæ•´ç¤ºä¾‹é›†
- ğŸ“š **[API Reference](/story/schema-api-reference)** - å®Œæ•´çš„ API æ–‡æ¡£
- ğŸ’¡ **[Best Practices](/story/schema-best-practices)** - æœ€ä½³å®è·µæŒ‡å—
- ğŸŸ¦ **[Basic Fields](/story/schema-basic-fields--string)** - åŸºç¡€å­—æ®µè¯¦è§£
- ğŸŸª **[Relation Fields](/story/schema-relation-fields--belongs-to)** - å…³è”å­—æ®µè¯¦è§£
- âœ… **[Validation](/story/schema-validation--required-validation)** - éªŒè¯ç³»ç»Ÿ
- ğŸ”¤ **[Type Inference](/story/schema-type-inference--basic-inference)** - ç±»å‹æ¨å¯¼

---

## æ€»ç»“

Schema Component æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€ç±»å‹å®‰å…¨ã€é«˜æ€§èƒ½çš„ Schema ç³»ç»Ÿï¼Œæ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„ç±»å‹ç³»ç»Ÿ** - æ”¯æŒæ‰€æœ‰å¸¸è§åŸºç¡€ç±»å‹å’Œå…³è”ç±»å‹
âœ… **çµæ´»çš„ API** - é“¾å¼è°ƒç”¨ã€withOption åŒ…è£…ã€ç±»å‹æ¨å¯¼
âœ… **å¼ºå¤§çš„éªŒè¯** - åŸºäº Zodï¼Œæ”¯æŒåŒæ­¥/å¼‚æ­¥ã€è‡ªå®šä¹‰è§„åˆ™
âœ… **äº’æ“ä½œæ€§** - JSON Schemaã€TypeBoxã€OpenAPIã€Prisma
âœ… **æˆç†Ÿç”Ÿæ€** - ä¸ tRPCã€React Hook Form ç­‰å·¥å…·æ— ç¼é›†æˆ
âœ… **å¯æ‰©å±•** - Schema ç»„åˆã€ç»§æ‰¿ã€è™šæ‹Ÿå­—æ®µã€æ¡ä»¶éªŒè¯

---

**æŠ€æœ¯æ ˆ**: åŸºäº **Zod** (æ ¸å¿ƒéªŒè¯å¼•æ“) å’Œ **TypeBox** (JSON Schema åºåˆ—åŒ–) æ„å»º
