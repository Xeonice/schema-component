import { Meta } from '@storybook/blocks'

<Meta title="Engine/Architecture" />

# Engine 架构文档

这里包含了 @schema-component/engine 的完整架构设计文档。

## 📚 架构设计

### 核心架构

深入了解 Engine 的整体架构和设计原则：

#### [Architecture Overview](/docs/engine-architecture-overview)
**Engine 架构总览**

核心内容：
- **整体架构** - 5层分层架构设计
- **设计原则** - DDD、框架无关、类型安全等
- **技术选型** - MobX、InversifyJS、EventEmitter3
- **核心概念** - Model、Repository、State、Event

**适合阅读对象**：
- 初次了解项目的开发者
- 想要理解整体架构的开发者
- 架构设计参考

---

#### [Function-First Design](/docs/engine-architecture-function-first-design)
**函数式优先设计理念**

核心内容：
- **核心理念** - 为什么采用函数式优先
- **APIs as Functions** - API 定义即可执行函数
- **Actions as Functions** - Action 可访问 context
- **Views as Functions** - 动态生成视图配置
- **完整示例** - 实际应用示例代码

**适合阅读对象**：
- 想要理解设计理念的开发者
- 需要实现自定义 API/Action 的开发者
- 对比传统配置方式的开发者

---

### 核心分层

深入了解 Engine 的 5 层架构设计和各层职责：

#### [Model Layer](/docs/engine-core-layers-model-layer)
**领域模型层**

核心内容：
- **统一定义** - Schema、Views、Actions、APIs、Hooks 集中定义
- **函数式优先** - APIs 和 Actions 都是可执行函数
- **Context 访问** - 通过 context 访问 repository、eventBus 等
- **生命周期** - 完整的 CRUD 生命周期钩子
- **完整示例** - User Model 完整实现示例

**适合阅读对象**：
- 需要定义业务模型的开发者
- 想要理解 Model 设计的开发者
- 需要实现自定义 Actions/APIs 的开发者

---

#### [Repository Layer](/docs/engine-core-layers-repository-layer)
**数据访问协调层**

核心内容：
- **统一接口** - 标准的 CRUD 接口定义
- **缓存管理** - 智能缓存策略和失效机制
- **数据转换** - 在业务层和数据层之间转换格式
- **批量操作** - 高效的批量 CRUD 支持
- **错误处理** - 统一的错误处理和重试机制

**适合阅读对象**：
- 需要实现数据访问的开发者
- 想要理解缓存策略的开发者
- 需要优化数据访问性能的开发者

---

#### [State Layer](/docs/engine-core-layers-state-layer)
**响应式状态管理层**

核心内容：
- **MobX 集成** - 基于 MobX 的响应式状态管理
- **ModelStore** - 模型数据状态管理
- **ViewStore** - 视图状态管理（选择、过滤、排序）
- **自动追踪** - 依赖自动追踪和最小化更新
- **框架集成** - React/Vue 集成示例

**适合阅读对象**：
- 需要管理应用状态的开发者
- 想要理解响应式编程的开发者
- 需要集成前端框架的开发者

---

#### [Data Access Layer](/docs/engine-core-layers-data-access-layer)
**数据源访问层**

核心内容：
- **协议无关** - 统一的 IDataAccessClient 接口
- **HTTP 实现** - 完整的 HTTP 客户端实现（Phase 1）
- **URL 映射** - REST 风格的 URL 映射器
- **拦截器** - 请求/响应/错误拦截器支持
- **扩展路线** - GraphQL、WebSocket、gRPC 扩展计划

**适合阅读对象**：
- 需要对接后端 API 的开发者
- 想要理解数据访问抽象的开发者
- 需要扩展新协议支持的开发者

---

### 渲染系统架构

深入了解 Engine 的渲染系统设计和实现原理：

#### [Render Architecture](/docs/engine-docs-renderarchitecture)
**渲染层架构设计（最终版）**

核心内容：
- **架构原则** - 分层职责和核心理念
- **Engine 层** - Renderer 接口定义（DataRenderer、ViewRenderer、ActionRenderer）
- **状态管理** - ViewStack、ActionQueue、RenderEngine
- **Framework 层** - React/Vue 等框架的具体实现
- **使用示例** - 完整的使用流程和代码示例

**适合阅读对象**：
- 想要理解整体渲染架构的开发者
- 需要实现自定义 Renderer 的开发者
- 框架集成开发者

---

#### [Render Design](/docs/engine-docs-renderdesign)
**三层 Renderer 架构设计**

核心内容：
- **DataRenderer** - 字段级渲染，基于 Schema 类型
- **ViewRenderer** - 视图级渲染，基于 View 类型
- **ActionRenderer** - 动作渲染，支持多种展示模式
- **完整实现** - 每个 Renderer 的详细实现代码
- **使用示例** - 实际使用场景和代码

**适合阅读对象**：
- 需要实现字段渲染器的开发者
- 需要实现视图渲染器的开发者
- 需要实现动作渲染器的开发者

---

#### [Render Layer Design](/docs/engine-docs-renderlayerdesign)
**渲染分层设计详解**

核心内容：
- **DataRenderer** - 字段级渲染（支持 view/edit 模式）
- **ViewRenderer** - 视图级渲染（list/form/detail/kanban 等）
- **ActionRenderer** - 动作渲染 + 状态管理（ViewStack & ActionQueue）
- **RenderEngine** - 统一管理所有 Renderer
- **完整流程** - 从注册到渲染的完整流程

**适合阅读对象**：
- 需要深入理解分层设计的开发者
- 需要理解状态管理的开发者
- 架构设计者

---

#### [Action Renderer Design](/docs/engine-docs-actionrendererdesign)
**Action 渲染器设计**

核心内容：
- **Action 分类** - ServerAction vs ViewAction
- **类型定义** - 完整的 TypeScript 类型系统
- **ServerActionRenderer** - 基类实现和扩展
- **ViewActionRenderer** - 各种 View Action 的实现
- **ActionRendererRegistry** - 统一注册管理
- **使用示例** - 完整的使用场景

**适合阅读对象**：
- 需要实现自定义 Action Renderer 的开发者
- 需要理解 Action 执行流程的开发者
- 需要扩展 Action 功能的开发者

---

## 🔍 阅读建议

### 入门顺序

如果你是第一次接触 Engine，建议按照以下顺序阅读：

#### 阶段 1: 了解整体架构
1. **[Architecture Overview](/docs/engine-architecture-overview)** - 理解整体架构和设计原则
2. **[Function-First Design](/docs/engine-architecture-function-first-design)** - 理解核心设计理念

#### 阶段 2: 掌握核心分层
3. **[Model Layer](/docs/engine-core-layers-model-layer)** - 学习如何定义业务模型
4. **[Repository Layer](/docs/engine-core-layers-repository-layer)** - 理解数据访问协调
5. **[State Layer](/docs/engine-core-layers-state-layer)** - 掌握响应式状态管理
6. **[Data Access Layer](/docs/engine-core-layers-data-access-layer)** - 了解数据源访问

#### 阶段 3: 深入渲染系统
7. **[Render Architecture](/docs/engine-docs-renderarchitecture)** - 理解渲染系统架构
8. **[Render Layer Design](/docs/engine-docs-renderlayerdesign)** - 深入分层设计
9. **[Render Design](/docs/engine-docs-renderdesign)** - 了解三层 Renderer
10. **[Action Renderer Design](/docs/engine-docs-actionrendererdesign)** - 专注 Action 实现

### 按需查阅

如果你已经熟悉基础概念，可以根据具体需求直接查阅：

#### 核心分层
**定义业务模型**
→ [Model Layer](/docs/engine-core-layers-model-layer) - 完整的 Model 定义指南

**实现数据访问**
→ [Repository Layer](/docs/engine-core-layers-repository-layer) - Repository 和缓存策略

**管理应用状态**
→ [State Layer](/docs/engine-core-layers-state-layer) - MobX 响应式状态管理

**对接后端 API**
→ [Data Access Layer](/docs/engine-core-layers-data-access-layer) - HTTP 客户端和协议扩展

#### 渲染系统
**实现字段渲染器**
→ [Render Design](/docs/engine-docs-renderdesign) (DataRenderer 部分)

**实现视图渲染器**
→ [Render Design](/docs/engine-docs-renderdesign) (ViewRenderer 部分)

**实现动作渲染器**
→ [Action Renderer Design](/docs/engine-docs-actionrendererdesign)

**理解渲染状态管理**
→ [Render Layer Design](/docs/engine-docs-renderlayerdesign) (ActionRenderer 部分)

**框架集成**
→ [Render Architecture](/docs/engine-docs-renderarchitecture) (Framework 层部分)

---

## 🏗️ 架构总览

```
┌─────────────────────────────────────────────────────────┐
│  Framework Layer (React/Vue/...)                        │
│  - 具体的 UI 组件实现                                    │
│  - 具体的 Renderer 实现                                  │
│  - 框架特定的状态绑定                                    │
└─────────────────────────────────────────────────────────┘
                          ↑
                          │ 实现接口
                          │
┌─────────────────────────────────────────────────────────┐
│  Engine Layer (@schema-component/engine)                │
│                                                         │
│  ┌────────────────┐  ┌────────────────┐               │
│  │ DataRenderer   │  │ ViewRenderer   │               │
│  │   Interface    │  │   Interface    │               │
│  └────────────────┘  └────────────────┘               │
│                                                         │
│  ┌────────────────┐  ┌────────────────┐               │
│  │ ActionRenderer │  │  RenderEngine  │               │
│  │   Interface    │  │   (Registry)   │               │
│  └────────────────┘  └────────────────┘               │
│                                                         │
│  ┌────────────────┐  ┌────────────────┐               │
│  │   ViewStack    │  │  ActionQueue   │               │
│  │ (State Mgmt)   │  │ (State Mgmt)   │               │
│  └────────────────┘  └────────────────┘               │
└─────────────────────────────────────────────────────────┘
                          ↑
                          │ 使用
                          │
┌─────────────────────────────────────────────────────────┐
│  Model Layer (defineModel)                              │
│  - Schema 定义                                          │
│  - Views 定义                                           │
│  - Actions 定义                                         │
│  - APIs 定义                                            │
└─────────────────────────────────────────────────────────┘
```

---

## 💡 核心设计理念

### 1. 框架无关

Engine 层只定义接口，不依赖具体框架：
- ✓ 可以集成 React
- ✓ 可以集成 Vue
- ✓ 可以集成任何其他 UI 框架
- ✓ 甚至可以在服务端渲染

### 2. 分层清晰

三层 Renderer 各司其职：
- **DataRenderer** - 最细粒度，渲染单个字段
- **ViewRenderer** - 中间层，渲染整个视图
- **ActionRenderer** - 最高层，渲染和执行动作

### 3. 状态集中

所有状态由 Engine 层统一管理：
- **ViewStack** - 视图栈，管理导航历史
- **ActionQueue** - 动作队列，管理异步任务
- **RenderEngine** - 渲染引擎，统一注册和调度

### 4. 可扩展

灵活的扩展点：
- 自定义 DataRenderer
- 自定义 ViewRenderer
- 自定义 ActionRenderer
- 自定义状态管理策略

---

## 🔗 相关链接

- [Core Module](/docs/engine-core-overview) - 核心模型系统
- [DI Module](/docs/engine-di-overview) - 依赖注入
- [Event Module](/docs/engine-event-overview) - 事件系统
- [State Module](/docs/engine-state-overview) - 状态管理
- [Repository Module](/docs/engine-repository-overview) - 数据访问层

---

## 🎯 下一步

阅读完架构文档后，可以：

1. **查看交互式示例** - 浏览左侧导航的各个模块 Stories
2. **运行示例代码** - 查看 `packages/engine/examples/` 目录
3. **阅读 API 文档** - 了解详细的 API 使用方法
4. **开始实践** - 基于 Engine 构建你的应用

如有问题或建议，欢迎在 [GitHub Issues](https://github.com/Xeonice/schema-component/issues) 提交反馈。
